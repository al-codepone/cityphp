<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Form Handler</title>
        <meta name="description" content=""/>
        <meta charset="utf-8"/>
        <link type="text/css" rel="stylesheet" href="styles.css"/>
    </head>
    <body>
        <a href="index.html">< Home</a>
        <h2>Form Handler</h2>
        <p>In this section we learn how to validate and process HTML forms with the help of the abstract FormHandler class. FormHandler only validates and collects POST variables; FormHandler does not help you render HTML forms. All the FormHandler validation occurs on the back-end; the cityphp framework does not come with any front-end form validation utilities. The source code for the example in this section is available in /sample_applications/example8/. What follows is an overview of the FormHandler concepts and then we will do an example contact form application.</p>
        <p>Let's go over the FormHandler class itself. FormHandler has a constructor that takes a single associative array parameter; this associative array is for setting the form input names and the form input default values as they relate to the FormHandler class. The array key is the form input name and the array value is the form input default value. Next, FormHandler has two getters: getValue() and getValues(). getValue() will return a single form input value. getValues() will return an associative array containing all the form input names and all the form input values. Next is the isReady() method. isReady() indicates whether or not the form is ready for validation and processing. Next is the validate() method. validate() does two important things: it will populate the values array with the submitted form values and it will return an array of errors. You define validation methods and error messages in your FormHandler child class(more on this in the next paragraph). You only want to call validate() after you've checked isReady(). The last method in FormHandler is addElement(). addElement() adds a form input name and form input default value. You should only call addElement() in your FormHandler child class constructor after you call the parent FormHandler constructor.</p>
        <p>Because FormHandler is an abstract class, you must extend it if you want to use it. Defining a FormHandler child class is easy. First you need to write a constructor that sets all the form input names and form input default values. You set the form input names and form input default values by using the parent FormHandler constructor and you can also use addElement(). In your FormHandler child class constructor, you must first always call the parent FormHandler constructor. Besides the constructor, the only other methods you need to define are validation methods. You can define a validation method for each form input name. The validation method names must use this format: 'validate_{form input name}'. For example if you have a form with an xname input and an xemail input then you can write a validate_xname() method and a validate_xemail() method. Each validate method must accept a single value parameter. The value parameter is the raw POST value. If the validation method has a valid value then return the empty string. If the value is invalid then return an error message. If you don't define a validation method for an input then it will always be valid.</p>
        <p>Now that we've gone over the FormHandler concepts, let's do a contact form example. We will build a simple contact form webpage with three form inputs: name, email and message. An error message will display at the top of the page if there is a submission error. For the contact form example we need to write six files: constants.php, styles.css, ContactFormHtmlBody.php, MessageHtmlBody.php, ContactFormHandler.php and index.php. Here is constants.php:</p>
        <pre>&lt;?php

define('CITY_PHP', '/somedir/cityphp/');
define('EXAMPLE8_PHP', '/somedir/example8php/');
define('ROOT', '/somedir/');
define('CSS', ROOT . 'css/');
define('TO_EMAIL', 'myname@mysite.com');

?&gt;</pre>
        <p>styles.css:</p>
        <pre>.error {
    color:#ff0000;
    margin-bottom:14px;
}

form &gt; div {
    margin-bottom:14px;
}</pre>
        <p>ContactFormHtmlBody.php:</p>
        <pre>&lt;?php

require_once(CITY_PHP . 'html/HtmlBody.php');

class ContactFormHtmlBody extends HtmlBody {
    private $formValues;
    private $errorMessage;

    public function __construct($bodyTag, array $formValues, $errorMessage = '') {
        parent::__construct($bodyTag);
        $this-&gt;formValues = $formValues;
        $this-&gt;errorMessage = $errorMessage;
    }

    public function draw() {
        ob_start();
        printf('%s&lt;div&gt;', $this-&gt;getBodyTag());

        if($this-&gt;errorMessage != '') {
            printf('&lt;div class="error"&gt;%s&lt;/div&gt;', $this-&gt;errorMessage);
        }

?&gt;
&lt;form action="&lt;?php echo ROOT; ?&gt;" method="post"&gt;
    &lt;div&gt;Name&lt;br/&gt;&lt;input type="text" name="xname" id="xname" value="&lt;?php $this-&gt;shrink('xname'); ?&gt;"/&gt;&lt;/div&gt;
    &lt;div&gt;Email&lt;br/&gt;&lt;input type="email" name="xemail" value="&lt;?php $this-&gt;shrink('xemail'); ?&gt;"/&gt;&lt;/div&gt;
    &lt;div&gt;Message&lt;br/&gt;&lt;textarea name="xmessage"&gt;&lt;?php $this-&gt;shrink('xmessage'); ?&gt;&lt;/textarea&gt;&lt;/div&gt;
    &lt;div&gt;&lt;input type="submit" value="Send"/&gt;&lt;/div&gt;
&lt;/form&gt;&lt;/div&gt;&lt;/body&gt;
&lt;?php

        $ob = ob_get_contents();
        ob_end_clean();
        return $ob;
    }

    private function shrink($key) {
        print htmlspecialchars($this-&gt;formValues[$key]);
    }
}

?&gt;</pre>
        <p>MessageHtmlBody.php:</p>
        <pre>&lt;?php

require_once(CITY_PHP . 'IView.php');

class MessageHtmlBody implements IView {
    private $message;

    public function __construct($message) {
        $this-&gt;message = $message;
    }

    public function draw() {
        return sprintf('&lt;body&gt;%s&lt;/body&gt;', $this-&gt;message);
    }
}

?&gt;</pre>
        <p>ContactFormHandler.php:</p>
        <pre>&lt;?php

require_once(CITY_PHP . 'forms/FormHandler.php');

class ContactFormHandler extends FormHandler {
    public function __construct() {
        $elementValues = array('xname' =&gt; '',
            'xemail' =&gt; '',
            'xmessage' =&gt; '');
        parent::__construct($elementValues);
    }

    protected function validate_xname($value) {
        if(trim($value) != '') {
            return '';
        }

        return 'Invalid name';
    }

    protected function validate_xemail($value) {
        if(strstr($value, '@')) {
            return '';
        }

        return 'Invalid email';
    }

    protected function validate_xmessage($value) {
        if(trim($value) != '') {
            return '';
        }

        return 'Invalid message';
    }
}

?&gt;</pre>
        <p>index.php:</p>
        <pre>&lt;?php

require_once('./constants.php');
require_once(CITY_PHP . 'html/HtmlDoc.php');
require_once(CITY_PHP . 'html/HtmlHead.php');
require_once(EXAMPLE8_PHP . 'forms/ContactFormHandler.php');
require_once(EXAMPLE8_PHP . 'html/ContactFormHtmlBody.php');
require_once(EXAMPLE8_PHP . 'html/MessageHtmlBody.php');

$htmlBody = null;
$bodyTag = '&lt;body&gt;';
$formHandler = new ContactFormHandler();

if($formHandler-&gt;isReady()) {
    $errors = $formHandler-&gt;validate();
    $formValues = $formHandler-&gt;getValues();

    if(count($errors) &gt; 0) {
        $htmlBody = new ContactFormHtmlBody($bodyTag, $formValues, current($errors));
    }
    else {
        $emailHeaders = 'From: ' . $formValues['xname'] . ' &lt;' . $formValues['xemail'] . "&gt;\r\n";
        $emailSuccess = mail(TO_EMAIL, 'Message #' . time(), $formValues['xmessage'], $emailHeaders);

        if($emailSuccess) {
            $htmlBody = new MessageHtmlBody('Your email was successfully sent. Thank you.');
        }
        else {
            $htmlBody = new ContactFormHtmlBody($bodyTag, $formValues,
                'An error occured while sending your email. Please try again in a few minutes.');
        }
    }
}
else {
    $bodyTag = '&lt;body onLoad="document.getElementById(\'xname\').focus();"&gt;';
    $htmlBody = new ContactFormHtmlBody($bodyTag, $formHandler-&gt;getValues());
}

$tags = array('&lt;title&gt;Contact Form&lt;/title&gt;',
    '&lt;meta name="description" content=""/&gt;',
    '&lt;link type="text/css" rel="stylesheet" href="' . CSS . 'styles.css"/&gt;');

$htmlHead = new HtmlHead($tags);
$htmlDoc = new HtmlDoc($htmlHead, $htmlBody);
print $htmlDoc-&gt;draw();

?&gt;</pre>
        <p>Let's review the above contact form example. constants.php has the usual constants plus a TO_EMAIL constant. The contact form message is sent to the TO_EMAIL email address. Next is styles.css; styles.css has CSS for the error message and the contact form.</p>
        <p>ContactFormHtmlBody is an HTML body class that extends HtmlBody. The ContactFormHtmlBody constructor passes the body tag up to the parent HtmlBody constructor. The ContactFormHtmlBody constructor also sets a formValues variable and an errorMessage variable. The formValues are used for the form input starting values and they come from a call to the FormHandler getValues() method. The errorMessage is displayed at the top of the webpage if it is non-empty. Next, if you take a look at the draw() method you can see the HTML structure. There's a body tag and then a top-level div. Inside the top-level div there is an error message div and a form. The private shrink() method helps to make the code more readable. The next file is MessageHtmlBody. MessageHtmlBody is for displaying a success message when the email message is successfully sent.</p>
        <p>ContactFormHandler extends FormHandler. The ContactFormHandler constructor uses an array and the parent FormHandler constructor in order to set the form input names that need to be handled; the same array is used to set the default form input values. We will see how to use the default form input values when we discuss index.php below. After the ContactFormHandler constructor, we define a validation method for each form input name that we previously set in the constructor. Once again, your validation methods must return an empty string when the value is valid and they must return an error message when the value is invalid. If you look at the validation methods in ContactFormHandler, you can see that validate_xname() and validate_xmessage() are practically the same; they're both valid if the trimmed value is not equal to the empty string and invalid otherwise. validate_xemail() is similar; validate_xemail() is valid if the value contains an '@' character and invalid otherwise.</p>
        <p>The last file is index.php. In index.php we first require_once() constants.php and all the class files we need. Next we instantiate a ContactFormHandler object. Next you can see we have nested if else statements; this if else structure is how you will normally use a FormHandler object. If isReady() is true then we know we can call validate(). Calling validate() returns an array of errors and it will also set the form input values in our FormHandler object so that we can get the submitted POST values using getValue() and getValues(). You can check to see if there were any submission errors by using the PHP count() function on the array of errors returned by validate(). If isReady() is false then we assume the user is visiting the page for the first time and we set the form up accordingly. You can see in the above example, when isReady() is false we use the opening body tag to autofocus the xname input. The other important thing to note when isReady() is false is that we are calling getValues() without having first called validate(). If you call getValue() or getValues() without first calling validate(), then you will get the default form input values that were set in the FormHandler child class constructor.</p>
        <p>This is the end of the form handler section. There is another example of FormHandler in /sample_applications/guestbook/.</p>
    </body>
</html>
